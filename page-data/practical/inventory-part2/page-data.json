{"componentChunkName":"component---src-pages-practical-inventory-part-2-index-mdx","path":"/practical/inventory-part2/","result":{"pageContext":{"isCreatedByStatefulCreatePages":true,"frontmatter":{"title":"Inventory Micro App - Part 2"},"relativePagePath":"/practical/inventory-part2/index.mdx","titleType":"page","MdxNode":{"id":"b00e2d6b-6b43-567a-9a29-9de5a2cba0a2","children":[],"parent":"dc52dfea-e647-5932-b0dd-3865bd498282","internal":{"content":"---\ntitle: Inventory Micro App - Part 2\n---\n\n<PageDescription>\n\nAn example three tier application architecture you can build and have deployed in IBM Kubernetes service or IBM Red Hat OpenShift in less than an hour using the IBM Garage for Cloud Developer Tools and Starter Kit Templates.\n\n</PageDescription>\n\n<AnchorLinks>\n  <AnchorLink to=\"#inventory-service\">Using CD to deliver to Test</AnchorLink>\n  <AnchorLink to=\"#inventory-bff\">Securing the User Interface</AnchorLink>\n  <AnchorLink to=\"#Inventory UI\">Integrating with NoSQL Database</AnchorLink>\n</AnchorLinks>\n\n## Guide\n\nThis Micro App guidance continues to build upon the microserivces that were built in the [Inventory Micro App Part 1](/practical/inventory-part1) guide. Make sure you have complete [Part 1](/practical/inventory-part1) or deployed the working [Inventory Solution](/practical/inventory-part1#solution-links)\n\nPart 2 of the guide is a follow on from Part 2 and will concentrate on building out the following areas:\n\n- Delivering the solution images into the `test` namespace/project using CD techniques and ArgoCD\n- Enabling application security with **App ID**\n- Adding **Cloudant** database and populating it with data\n\n### Using CD to deliver to Test\n\n### Securing the solution with **App ID**\n\n#### User Interface\n\n1. Update the `values.yaml` file in the chart to set `ingress.appId.enabled=true` and to set the value for the AppId binding secret\n\n```yaml path=/chart/template-java-spring/values.yaml\n...\nappidBinding: \"binding-sms-test-oc-appid\"\n\ningress:\n  enabled: true\n  appid:\n    enabled: true\n    # web or app - https://cloud.ibm.com/docs/services/appid?topic=appid-kube-auth\n    requestType: web\n    ...\n```\n\n#### AppId redirect url config\n\n1. When the UI application is available, navigate to the https url. An error page should be displayed that looks like the\nfollowing:\n    ![AppId redirect error](images/appid-redirect-error.png)\n\n2. The url for the error page will look like the following:\n\n    `https://us-south.appid.cloud.ibm.com/oauth/v4/25d16cda-8899-46fa-a5ae-9818f93dd1d3/authorization?client_id=0351c750-a3f0-4b8c-818b-d14558f9dfb9&response_type=code&redirect_uri=https://inventory-manangement-ui-dev.sms-test-oc-cluster.us-east.containers.appdomain.cloud/appid_callback&scope=appid_default`\n\n    Get the value of the `redirect_url` parameter.\n\n3. Open the IBM Cloud resource list - `https://cloud.ibm.com/resources`\n\n4. Open the AppId instance to the `Manage Authentication` -> `Authentication Settings`\n\n    ![AppId authentication settings](images/appid-authentication-settings.png)\n\n5. Add the `redirect_url` to the web redirect URLs\n\n#### Add users to AppId\n\n1. Open the AppId instance to `Cloud Directory` -> `Users`\n\n    ![AppId cloud directory users](images/appid-cloud-directory-users.png)\n\n2. Add users\n\n\n### Integrating with NoSQL Database\n\n\nThe initial setup\n\n\nThis exercise will Create a Cloud Native NoSQL Database and populate it with data. You will then access the data through a Spring Boot micro service REST API.\n\n \t- Create the Database instance\n \t- Populate it with sample data\n\n\n- While logged into the IBM Cloud account use the resource list to find your pre installed Cloudant datbase instance.\n\n- Open the database instance dashboard.\n\n- After the create is successful, you will see the Database instance Manage view.  From here you can click on the Launch button to access the database management views. We now need to configure the command line so you can upload data.\n\n- Click on the Service Credentials on the left-hand menu.\n- If there are no credentials created, click *New Credentials* button and in the dialog click *Add*. These control the access to the database. Are the credentials have been created you should see a screen similar to the one below.\n\n\n-  Open a command prompt and create a folder/directory called `data`\n\n```\nmkdir data\n```\n\n- To help create test JSON data we are going to supply a template to the JSON Generator tool, this helps when creating dummy data for testing. Navigate to the following link.\n\n-  https://next.json-generator.com\n\n- Replace the default template with the following template (using cut and paste). This will enable a 100 records of test data to be created to represent a products database. Click on the *Generate* button.\n\n```bash\n[\n  {\n    'repeat(1, 100)': {\n      name: '{{lorem(2, \"words\")}}',\n      guid: '{{guid()}}',\n      delivered: '{{bool()}}'\n    }\n  }\n]\n```\n- Copy the generated contents on the right hand side into a file called `inventory.json` and save it into the same folder. Wrap the array with a docs statement.\n\n```json\n{\n  \"docs\": {Add Generated array []}\n}\n```\n- Save the documents that will be loaded into Cloudant\n\n- Using a code editor create a shell script called `load.sh` that will load data into the database using a `curl` command. Use the contents from below for the script.\n\n```\n#!/bin/sh\n# Cloudant Database Data Load Utility\n\n# Credentials from IBM Cloud\nCLOUDANT_USERNAME=\nCLOUDANT_PASSWORD=\n\n# name of database\nDATABASE=inventor-{initials}\n\n# input validation\nif [ -z \"${CLOUDANT_USERNAME}\" ]; then\n    echo \"Please provide your CLOUDANT_USERNAME.\"\n    exit\nfi\nif [ -z \"${CLOUDANT_PASSWORD}\" ]; then\n    echo \"Please provide your CLOUDANT_PASSWORD.\"\n    exit\nfi\n\n# credentials to post data to cloudant\nAUTH=$(echo \"${CLOUDANT_USERNAME}:${CLOUDANT_PASSWORD}\" | base64)\nACURL=\"curl -s --proto '=https' -iv -g -H 'Authorization: Basic ${AUTH}'\"\nHOST=\"https://${CLOUDANT_USERNAME}.cloudant.com\"\n\n# Inventory\neval ${ACURL} -X DELETE '${HOST}/${DATABASE}'\neval ${ACURL} -X PUT '${HOST}/${DATABASE}'\neval ${ACURL} -H \"Content-Type:application/json\" -d @inventory.json -vX POST '${HOST}/${DATABASE}/_bulk_docs'\n```\n\n- Replace the {CLOUDANT_USERNAME} and {CLOUDANT_PASSWORD} fields with values from the Credentials section of the Cloudant instance in the dashboard.\n- Add database name `inventor-{initials}` using the initials that you have used before.\n- Save the script, make it executable, and then run it.\n```\nchmod +x ./load.sh\n./load.sh\n```\n- The data from the `inventory.json` file will then be used to populate the database, to confirm this on the Dashboard click on Manage menu on the left and then Launch  button to see the Cloudant dashboard.\n- Click on the Left icon that looks like a Database and you will see the products database created.\n\n- Click on the products database itself.\n- You can see the rows of data\n- If you click on a row of data, you will see the raw NoSQL form of the data record.\n- This completes the setup of the database and populating it with data. We will be now moving onto creating a Spring Micro service that then uses this database to display Product details.\n\nThis completes the data load activities.\n\n### Add a Cloudant integration to your backend service\n\n#### Update the gradle config to include cloudant dependencies\n\n1. Add `build-services.gradle` to the gradle folder\n\n    gradle/build-services.gradle\n    ```\n    dependencies {\n        compile group: 'com.cloudant', name: 'cloudant-client', version: '2.17.0'\n        compile group: 'com.jayway.jsonpath', name: 'json-path', version: '2.4.0'\n        compile group: 'javax.xml.bind', name: 'jaxb-api', version: '2.1'\n        compile group: 'joda-time', name: 'joda-time', version: '2.10.3'\n    }\n    ```\n\n2. Apply build-services.gradle to build.gradle\n\n    build.gradle\n    ```\n    ...\n    apply from:   'gradle/build-services.gradle'\n    ...\n    ```\n\n#### Add configuration values\n\n1. Add CloudantConfig to hold the url, username, password, and databaseName values\n\n    com.ibm.inventory_management.config.CloudantConfig\n    ```java\n    package com.ibm.inventory_management.config;\n\n    import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n\n    @JsonIgnoreProperties(ignoreUnknown = true)\n    public class CloudantConfig {\n        private String url;\n        private String username;\n        private String password;\n        private String databaseName;\n\n        public String getUrl() {\n            return url;\n        }\n\n        public void setUrl(String url) {\n            this.url = url;\n        }\n\n        public CloudantConfig withUrl(String url) {\n            this.setUrl(url);\n\n            return this;\n        }\n\n        public String getUsername() {\n            return username;\n        }\n\n        public void setUsername(String username) {\n            this.username = username;\n        }\n\n        public CloudantConfig withUsername(String username) {\n            this.setUsername(username);\n\n            return this;\n        }\n\n        public String getPassword() {\n            return password;\n        }\n\n        public void setPassword(String password) {\n            this.password = password;\n        }\n\n        public CloudantConfig withPassword(String password) {\n            this.setPassword(password);\n\n            return this;\n        }\n\n        public String getDatabaseName() {\n            return databaseName;\n        }\n\n        public void setDatabaseName(String databaseName) {\n            this.databaseName = databaseName;\n        }\n\n        public CloudantConfig withDatabaseName(String databaseName) {\n            this.setDatabaseName(databaseName);\n\n            return this;\n        }\n\n        public String toString() {\n            return \"[CloudantConfig: url=\" + this.url + \", username=\" + this.username + \", name=\" + this.databaseName + \"]\";\n        }\n    }\n    ```\n\n2. Implement logic to load the configuration from the secret binding or local file\n\n    com.ibm.inventory_management.config.CloudantMapping\n    ```java\n    package com.ibm.inventory_management.config;\n\n    import java.io.Serializable;\n\n    import com.fasterxml.jackson.annotation.JsonProperty;\n\n    public class CloudantMapping implements Serializable {\n        @JsonProperty(value = \"CLOUDANT_CONFIG\")\n        private String cloudantConfig;\n\n        public String getCloudantConfig() {\n            return cloudantConfig;\n        }\n\n        public void setCloudantConfig(String cloudantConfig) {\n            this.cloudantConfig = cloudantConfig;\n        }\n    }\n    ```\n\n    com.ibm.inventory_management.config.CloudantConfigFactory\n    ```java\n    package com.ibm.inventory_management.config;\n\n    import java.io.IOException;\n\n    import com.fasterxml.jackson.databind.ObjectMapper;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.stereotype.Component;\n\n    @Component\n    public class CloudantConfigFactory {\n        @Bean\n        public CloudantConfig buildCloudantConfig() throws IOException {\n            return buildConfigFromBinding(\n                    loadCloudantConfig(),\n                    loadDatabaseName()\n            );\n        }\n\n        protected String loadCloudantConfig() throws IOException {\n            return System.getProperty(\"CLOUDANT_CONFIG\") != null\n                    ? System.getProperty(\"CLOUDANT_CONFIG\")\n                    : loadCloudantConfigFromLocalDev();\n        }\n\n        protected String loadCloudantConfigFromLocalDev() throws IOException {\n            final ObjectMapper mapper = new ObjectMapper();\n\n            final CloudantMapping mappings = mapper.readValue(\n                    this.getClass().getClassLoader().getResourceAsStream(\"mappings.json\"),\n                    CloudantMapping.class\n            );\n\n            return mappings.getCloudantConfig();\n        }\n\n        protected String loadDatabaseName() {\n            return System.getProperty(\"DATABASE_NAME\") != null\n                    ? System.getProperty(\"DATABASE_NAME\")\n                    : \"stock-items\";\n        }\n\n        protected CloudantConfig buildConfigFromBinding(String binding, String databaseName) throws IOException {\n            final ObjectMapper mapper = new ObjectMapper();\n\n            return mapper.readValue(binding, CloudantConfig.class)\n                    .withDatabaseName(databaseName);\n        }\n    }\n    ```\n\n#### Set up local development\n\n1. Log into cloud.ibm.com and open the Cloudant service from the resource list\n\n2. Click on service credentials and expand the listed credentials\n\n3. Copy the json contents from the credentials into `mappings.json` under CLOUDANT_CONFIG\n\n    src/main/resources/mappings.json\n    ```\n    {\n      \"CLOUDANT_CONFIG\": \"{paste json here}\"\n    }\n    ```\n\n#### Implement the service\n\n1. Add a CloudantApi component to create the CloudantClient instance from the configuration\n\n    com.ibm.inventory_management.service.CloudServicesException\n    ```java\n    package com.ibm.inventory_management.service;\n\n    public class CloudServicesException extends Exception {\n        public CloudServicesException() {\n        }\n\n        public CloudServicesException(String message) {\n            super(message);\n        }\n\n        public CloudServicesException(String message, Throwable cause) {\n            super(message, cause);\n        }\n\n        public CloudServicesException(Throwable cause) {\n            super(cause);\n        }\n\n        public CloudServicesException(\n                String message,\n                Throwable cause,\n                boolean enableSuppression,\n                boolean writableStackTrace\n        ) {\n            super(message, cause, enableSuppression, writableStackTrace);\n        }\n    }\n    ```\n\n    com.ibm.inventory_management.service.CloudantApi\n    ```java\n    package com.ibm.inventory_management.service;\n\n    import java.net.MalformedURLException;\n    import java.net.URL;\n\n    import com.cloudant.client.api.ClientBuilder;\n    import com.cloudant.client.api.CloudantClient;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.stereotype.Component;\n\n    import com.ibm.inventory_management.config.CloudantConfig;\n\n    @Component\n    public class CloudantApi {\n        @Bean\n        public CloudantClient buildCloudant(CloudantConfig config) throws CloudServicesException {\n            System.out.println(\"Config: \" + config);\n            URL url = null;\n            try {\n                url = new URL(config.getUrl());\n            } catch (MalformedURLException e) {\n                throw new CloudServicesException(\"Invalid service URL specified\", e);\n            }\n\n            return ClientBuilder\n                    .url(url)\n                    .username(config.getUsername())\n                    .password(config.getPassword())\n                    .build();\n        }\n    }\n    ```\n\n2. Add the service implementation\n\n    com.ibm.inventory_management.service.StockItemService\n    ```java\n    package com.ibm.inventory_management.service;\n\n    import java.io.IOException;\n    import java.util.List;\n    import javax.annotation.PostConstruct;\n\n    import com.cloudant.client.api.CloudantClient;\n    import com.cloudant.client.api.Database;\n    import org.springframework.context.annotation.Primary;\n    import org.springframework.stereotype.Service;\n\n    import com.ibm.inventory_management.config.CloudantConfig;\n    import com.ibm.inventory_management.model.StockItem;\n\n    @Service\n    @Primary\n    public class StockItemService implements StockItemApi {\n        private CloudantConfig config;\n        private CloudantClient client;\n        private Database db = null;\n\n        public StockItemService(CloudantConfig config, CloudantClient client) {\n            this.config = config;\n            this.client = client;\n        }\n\n        @PostConstruct\n        public void init() {\n            db = client.database(config.getDatabaseName(), true);\n        }\n\n        @Override\n        public List<StockItem> listStockItems() throws Exception {\n\n            try {\n                return db.getAllDocsRequestBuilder()\n                        .includeDocs(true)\n                        .build()\n                        .getResponse()\n                        .getDocsAs(StockItem.class);\n\n            } catch (IOException e) {\n                throw new Exception(\"\", e);\n            }\n        }\n    }\n    ```\n\n3. Remove the `@Primary` annotation from the mock service\n\n#### Add the values to the helm chart\n\n1. Update the `cloudantBinding` and `databaseName` values in values.yaml\n\n    **Note:** The cloudantBinding value should match the name of the cloudant binding secret\n\n## Summary\n\nYou have now completed the Micro App Guide demonstrating the _Inventory_ solution.\n\n## Solution Links\n\nIf you want to skip the guide and just get the components running, here are the solution Git Repositories. You can clone these and `igc pipeline` them to register them in the CI pipeline. The **README.md** may include additional setup for populating test data etc.\n\n<AnchorLinks>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-ui\">Inventory Management User Interface</AnchorLink>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-bff\">Inventory Management Backend for Frontend</AnchorLink>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-service\">Inventory Management Microservice</AnchorLink>\n</AnchorLinks>\n","type":"Mdx","contentDigest":"1dd11d5e4d2d2d5cbc04b31462867d4e","counter":653,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"Inventory Micro App - Part 2"},"exports":{},"rawBody":"---\ntitle: Inventory Micro App - Part 2\n---\n\n<PageDescription>\n\nAn example three tier application architecture you can build and have deployed in IBM Kubernetes service or IBM Red Hat OpenShift in less than an hour using the IBM Garage for Cloud Developer Tools and Starter Kit Templates.\n\n</PageDescription>\n\n<AnchorLinks>\n  <AnchorLink to=\"#inventory-service\">Using CD to deliver to Test</AnchorLink>\n  <AnchorLink to=\"#inventory-bff\">Securing the User Interface</AnchorLink>\n  <AnchorLink to=\"#Inventory UI\">Integrating with NoSQL Database</AnchorLink>\n</AnchorLinks>\n\n## Guide\n\nThis Micro App guidance continues to build upon the microserivces that were built in the [Inventory Micro App Part 1](/practical/inventory-part1) guide. Make sure you have complete [Part 1](/practical/inventory-part1) or deployed the working [Inventory Solution](/practical/inventory-part1#solution-links)\n\nPart 2 of the guide is a follow on from Part 2 and will concentrate on building out the following areas:\n\n- Delivering the solution images into the `test` namespace/project using CD techniques and ArgoCD\n- Enabling application security with **App ID**\n- Adding **Cloudant** database and populating it with data\n\n### Using CD to deliver to Test\n\n### Securing the solution with **App ID**\n\n#### User Interface\n\n1. Update the `values.yaml` file in the chart to set `ingress.appId.enabled=true` and to set the value for the AppId binding secret\n\n```yaml path=/chart/template-java-spring/values.yaml\n...\nappidBinding: \"binding-sms-test-oc-appid\"\n\ningress:\n  enabled: true\n  appid:\n    enabled: true\n    # web or app - https://cloud.ibm.com/docs/services/appid?topic=appid-kube-auth\n    requestType: web\n    ...\n```\n\n#### AppId redirect url config\n\n1. When the UI application is available, navigate to the https url. An error page should be displayed that looks like the\nfollowing:\n    ![AppId redirect error](images/appid-redirect-error.png)\n\n2. The url for the error page will look like the following:\n\n    `https://us-south.appid.cloud.ibm.com/oauth/v4/25d16cda-8899-46fa-a5ae-9818f93dd1d3/authorization?client_id=0351c750-a3f0-4b8c-818b-d14558f9dfb9&response_type=code&redirect_uri=https://inventory-manangement-ui-dev.sms-test-oc-cluster.us-east.containers.appdomain.cloud/appid_callback&scope=appid_default`\n\n    Get the value of the `redirect_url` parameter.\n\n3. Open the IBM Cloud resource list - `https://cloud.ibm.com/resources`\n\n4. Open the AppId instance to the `Manage Authentication` -> `Authentication Settings`\n\n    ![AppId authentication settings](images/appid-authentication-settings.png)\n\n5. Add the `redirect_url` to the web redirect URLs\n\n#### Add users to AppId\n\n1. Open the AppId instance to `Cloud Directory` -> `Users`\n\n    ![AppId cloud directory users](images/appid-cloud-directory-users.png)\n\n2. Add users\n\n\n### Integrating with NoSQL Database\n\n\nThe initial setup\n\n\nThis exercise will Create a Cloud Native NoSQL Database and populate it with data. You will then access the data through a Spring Boot micro service REST API.\n\n \t- Create the Database instance\n \t- Populate it with sample data\n\n\n- While logged into the IBM Cloud account use the resource list to find your pre installed Cloudant datbase instance.\n\n- Open the database instance dashboard.\n\n- After the create is successful, you will see the Database instance Manage view.  From here you can click on the Launch button to access the database management views. We now need to configure the command line so you can upload data.\n\n- Click on the Service Credentials on the left-hand menu.\n- If there are no credentials created, click *New Credentials* button and in the dialog click *Add*. These control the access to the database. Are the credentials have been created you should see a screen similar to the one below.\n\n\n-  Open a command prompt and create a folder/directory called `data`\n\n```\nmkdir data\n```\n\n- To help create test JSON data we are going to supply a template to the JSON Generator tool, this helps when creating dummy data for testing. Navigate to the following link.\n\n-  https://next.json-generator.com\n\n- Replace the default template with the following template (using cut and paste). This will enable a 100 records of test data to be created to represent a products database. Click on the *Generate* button.\n\n```bash\n[\n  {\n    'repeat(1, 100)': {\n      name: '{{lorem(2, \"words\")}}',\n      guid: '{{guid()}}',\n      delivered: '{{bool()}}'\n    }\n  }\n]\n```\n- Copy the generated contents on the right hand side into a file called `inventory.json` and save it into the same folder. Wrap the array with a docs statement.\n\n```json\n{\n  \"docs\": {Add Generated array []}\n}\n```\n- Save the documents that will be loaded into Cloudant\n\n- Using a code editor create a shell script called `load.sh` that will load data into the database using a `curl` command. Use the contents from below for the script.\n\n```\n#!/bin/sh\n# Cloudant Database Data Load Utility\n\n# Credentials from IBM Cloud\nCLOUDANT_USERNAME=\nCLOUDANT_PASSWORD=\n\n# name of database\nDATABASE=inventor-{initials}\n\n# input validation\nif [ -z \"${CLOUDANT_USERNAME}\" ]; then\n    echo \"Please provide your CLOUDANT_USERNAME.\"\n    exit\nfi\nif [ -z \"${CLOUDANT_PASSWORD}\" ]; then\n    echo \"Please provide your CLOUDANT_PASSWORD.\"\n    exit\nfi\n\n# credentials to post data to cloudant\nAUTH=$(echo \"${CLOUDANT_USERNAME}:${CLOUDANT_PASSWORD}\" | base64)\nACURL=\"curl -s --proto '=https' -iv -g -H 'Authorization: Basic ${AUTH}'\"\nHOST=\"https://${CLOUDANT_USERNAME}.cloudant.com\"\n\n# Inventory\neval ${ACURL} -X DELETE '${HOST}/${DATABASE}'\neval ${ACURL} -X PUT '${HOST}/${DATABASE}'\neval ${ACURL} -H \"Content-Type:application/json\" -d @inventory.json -vX POST '${HOST}/${DATABASE}/_bulk_docs'\n```\n\n- Replace the {CLOUDANT_USERNAME} and {CLOUDANT_PASSWORD} fields with values from the Credentials section of the Cloudant instance in the dashboard.\n- Add database name `inventor-{initials}` using the initials that you have used before.\n- Save the script, make it executable, and then run it.\n```\nchmod +x ./load.sh\n./load.sh\n```\n- The data from the `inventory.json` file will then be used to populate the database, to confirm this on the Dashboard click on Manage menu on the left and then Launch  button to see the Cloudant dashboard.\n- Click on the Left icon that looks like a Database and you will see the products database created.\n\n- Click on the products database itself.\n- You can see the rows of data\n- If you click on a row of data, you will see the raw NoSQL form of the data record.\n- This completes the setup of the database and populating it with data. We will be now moving onto creating a Spring Micro service that then uses this database to display Product details.\n\nThis completes the data load activities.\n\n### Add a Cloudant integration to your backend service\n\n#### Update the gradle config to include cloudant dependencies\n\n1. Add `build-services.gradle` to the gradle folder\n\n    gradle/build-services.gradle\n    ```\n    dependencies {\n        compile group: 'com.cloudant', name: 'cloudant-client', version: '2.17.0'\n        compile group: 'com.jayway.jsonpath', name: 'json-path', version: '2.4.0'\n        compile group: 'javax.xml.bind', name: 'jaxb-api', version: '2.1'\n        compile group: 'joda-time', name: 'joda-time', version: '2.10.3'\n    }\n    ```\n\n2. Apply build-services.gradle to build.gradle\n\n    build.gradle\n    ```\n    ...\n    apply from:   'gradle/build-services.gradle'\n    ...\n    ```\n\n#### Add configuration values\n\n1. Add CloudantConfig to hold the url, username, password, and databaseName values\n\n    com.ibm.inventory_management.config.CloudantConfig\n    ```java\n    package com.ibm.inventory_management.config;\n\n    import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n\n    @JsonIgnoreProperties(ignoreUnknown = true)\n    public class CloudantConfig {\n        private String url;\n        private String username;\n        private String password;\n        private String databaseName;\n\n        public String getUrl() {\n            return url;\n        }\n\n        public void setUrl(String url) {\n            this.url = url;\n        }\n\n        public CloudantConfig withUrl(String url) {\n            this.setUrl(url);\n\n            return this;\n        }\n\n        public String getUsername() {\n            return username;\n        }\n\n        public void setUsername(String username) {\n            this.username = username;\n        }\n\n        public CloudantConfig withUsername(String username) {\n            this.setUsername(username);\n\n            return this;\n        }\n\n        public String getPassword() {\n            return password;\n        }\n\n        public void setPassword(String password) {\n            this.password = password;\n        }\n\n        public CloudantConfig withPassword(String password) {\n            this.setPassword(password);\n\n            return this;\n        }\n\n        public String getDatabaseName() {\n            return databaseName;\n        }\n\n        public void setDatabaseName(String databaseName) {\n            this.databaseName = databaseName;\n        }\n\n        public CloudantConfig withDatabaseName(String databaseName) {\n            this.setDatabaseName(databaseName);\n\n            return this;\n        }\n\n        public String toString() {\n            return \"[CloudantConfig: url=\" + this.url + \", username=\" + this.username + \", name=\" + this.databaseName + \"]\";\n        }\n    }\n    ```\n\n2. Implement logic to load the configuration from the secret binding or local file\n\n    com.ibm.inventory_management.config.CloudantMapping\n    ```java\n    package com.ibm.inventory_management.config;\n\n    import java.io.Serializable;\n\n    import com.fasterxml.jackson.annotation.JsonProperty;\n\n    public class CloudantMapping implements Serializable {\n        @JsonProperty(value = \"CLOUDANT_CONFIG\")\n        private String cloudantConfig;\n\n        public String getCloudantConfig() {\n            return cloudantConfig;\n        }\n\n        public void setCloudantConfig(String cloudantConfig) {\n            this.cloudantConfig = cloudantConfig;\n        }\n    }\n    ```\n\n    com.ibm.inventory_management.config.CloudantConfigFactory\n    ```java\n    package com.ibm.inventory_management.config;\n\n    import java.io.IOException;\n\n    import com.fasterxml.jackson.databind.ObjectMapper;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.stereotype.Component;\n\n    @Component\n    public class CloudantConfigFactory {\n        @Bean\n        public CloudantConfig buildCloudantConfig() throws IOException {\n            return buildConfigFromBinding(\n                    loadCloudantConfig(),\n                    loadDatabaseName()\n            );\n        }\n\n        protected String loadCloudantConfig() throws IOException {\n            return System.getProperty(\"CLOUDANT_CONFIG\") != null\n                    ? System.getProperty(\"CLOUDANT_CONFIG\")\n                    : loadCloudantConfigFromLocalDev();\n        }\n\n        protected String loadCloudantConfigFromLocalDev() throws IOException {\n            final ObjectMapper mapper = new ObjectMapper();\n\n            final CloudantMapping mappings = mapper.readValue(\n                    this.getClass().getClassLoader().getResourceAsStream(\"mappings.json\"),\n                    CloudantMapping.class\n            );\n\n            return mappings.getCloudantConfig();\n        }\n\n        protected String loadDatabaseName() {\n            return System.getProperty(\"DATABASE_NAME\") != null\n                    ? System.getProperty(\"DATABASE_NAME\")\n                    : \"stock-items\";\n        }\n\n        protected CloudantConfig buildConfigFromBinding(String binding, String databaseName) throws IOException {\n            final ObjectMapper mapper = new ObjectMapper();\n\n            return mapper.readValue(binding, CloudantConfig.class)\n                    .withDatabaseName(databaseName);\n        }\n    }\n    ```\n\n#### Set up local development\n\n1. Log into cloud.ibm.com and open the Cloudant service from the resource list\n\n2. Click on service credentials and expand the listed credentials\n\n3. Copy the json contents from the credentials into `mappings.json` under CLOUDANT_CONFIG\n\n    src/main/resources/mappings.json\n    ```\n    {\n      \"CLOUDANT_CONFIG\": \"{paste json here}\"\n    }\n    ```\n\n#### Implement the service\n\n1. Add a CloudantApi component to create the CloudantClient instance from the configuration\n\n    com.ibm.inventory_management.service.CloudServicesException\n    ```java\n    package com.ibm.inventory_management.service;\n\n    public class CloudServicesException extends Exception {\n        public CloudServicesException() {\n        }\n\n        public CloudServicesException(String message) {\n            super(message);\n        }\n\n        public CloudServicesException(String message, Throwable cause) {\n            super(message, cause);\n        }\n\n        public CloudServicesException(Throwable cause) {\n            super(cause);\n        }\n\n        public CloudServicesException(\n                String message,\n                Throwable cause,\n                boolean enableSuppression,\n                boolean writableStackTrace\n        ) {\n            super(message, cause, enableSuppression, writableStackTrace);\n        }\n    }\n    ```\n\n    com.ibm.inventory_management.service.CloudantApi\n    ```java\n    package com.ibm.inventory_management.service;\n\n    import java.net.MalformedURLException;\n    import java.net.URL;\n\n    import com.cloudant.client.api.ClientBuilder;\n    import com.cloudant.client.api.CloudantClient;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.stereotype.Component;\n\n    import com.ibm.inventory_management.config.CloudantConfig;\n\n    @Component\n    public class CloudantApi {\n        @Bean\n        public CloudantClient buildCloudant(CloudantConfig config) throws CloudServicesException {\n            System.out.println(\"Config: \" + config);\n            URL url = null;\n            try {\n                url = new URL(config.getUrl());\n            } catch (MalformedURLException e) {\n                throw new CloudServicesException(\"Invalid service URL specified\", e);\n            }\n\n            return ClientBuilder\n                    .url(url)\n                    .username(config.getUsername())\n                    .password(config.getPassword())\n                    .build();\n        }\n    }\n    ```\n\n2. Add the service implementation\n\n    com.ibm.inventory_management.service.StockItemService\n    ```java\n    package com.ibm.inventory_management.service;\n\n    import java.io.IOException;\n    import java.util.List;\n    import javax.annotation.PostConstruct;\n\n    import com.cloudant.client.api.CloudantClient;\n    import com.cloudant.client.api.Database;\n    import org.springframework.context.annotation.Primary;\n    import org.springframework.stereotype.Service;\n\n    import com.ibm.inventory_management.config.CloudantConfig;\n    import com.ibm.inventory_management.model.StockItem;\n\n    @Service\n    @Primary\n    public class StockItemService implements StockItemApi {\n        private CloudantConfig config;\n        private CloudantClient client;\n        private Database db = null;\n\n        public StockItemService(CloudantConfig config, CloudantClient client) {\n            this.config = config;\n            this.client = client;\n        }\n\n        @PostConstruct\n        public void init() {\n            db = client.database(config.getDatabaseName(), true);\n        }\n\n        @Override\n        public List<StockItem> listStockItems() throws Exception {\n\n            try {\n                return db.getAllDocsRequestBuilder()\n                        .includeDocs(true)\n                        .build()\n                        .getResponse()\n                        .getDocsAs(StockItem.class);\n\n            } catch (IOException e) {\n                throw new Exception(\"\", e);\n            }\n        }\n    }\n    ```\n\n3. Remove the `@Primary` annotation from the mock service\n\n#### Add the values to the helm chart\n\n1. Update the `cloudantBinding` and `databaseName` values in values.yaml\n\n    **Note:** The cloudantBinding value should match the name of the cloudant binding secret\n\n## Summary\n\nYou have now completed the Micro App Guide demonstrating the _Inventory_ solution.\n\n## Solution Links\n\nIf you want to skip the guide and just get the components running, here are the solution Git Repositories. You can clone these and `igc pipeline` them to register them in the CI pipeline. The **README.md** may include additional setup for populating test data etc.\n\n<AnchorLinks>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-ui\">Inventory Management User Interface</AnchorLink>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-bff\">Inventory Management Backend for Frontend</AnchorLink>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-service\">Inventory Management Microservice</AnchorLink>\n</AnchorLinks>\n","fileAbsolutePath":"/Users/mjperrins/projects/cat/guide/src/pages/practical/inventory-part2/index.mdx"}}}}